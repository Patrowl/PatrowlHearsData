{"publishedDate": "2024-05-30T16:15Z", "lastModifiedDate": "2024-11-21T09:22Z", "cve": {"data_type": "CVE", "data_format": "MITRE", "data_version": "1.0", "CVE_data_meta": {"ID": "CVE-2024-36904", "ASSIGNER": "416baaa9-dc9f-4396-8d5f-8c081fb06d67"}, "description": {"description_data": [{"lang": "en", "value": "In the Linux kernel, the following vulnerability has been resolved:\n\ntcp: Use refcount_inc_not_zero() in tcp_twsk_unique().\n\nAnderson Nascimento reported a use-after-free splat in tcp_twsk_unique()\nwith nice analysis.\n\nSince commit ec94c2696f0b (\"tcp/dccp: avoid one atomic operation for\ntimewait hashdance\"), inet_twsk_hashdance() sets TIME-WAIT socket's\nsk_refcnt after putting it into ehash and releasing the bucket lock.\n\nThus, there is a small race window where other threads could try to\nreuse the port during connect() and call sock_hold() in tcp_twsk_unique()\nfor the TIME-WAIT socket with zero refcnt.\n\nIf that happens, the refcnt taken by tcp_twsk_unique() is overwritten\nand sock_put() will cause underflow, triggering a real use-after-free\nsomewhere else.\n\nTo avoid the use-after-free, we need to use refcount_inc_not_zero() in\ntcp_twsk_unique() and give up on reusing the port if it returns false.\n\n[0]:\nrefcount_t: addition on 0; use-after-free.\nWARNING: CPU: 0 PID: 1039313 at lib/refcount.c:25 refcount_warn_saturate+0xe5/0x110\nCPU: 0 PID: 1039313 Comm: trigger Not tainted 6.8.6-200.fc39.x86_64 #1\nHardware name: VMware, Inc. VMware20,1/440BX Desktop Reference Platform, BIOS VMW201.00V.21805430.B64.2305221830 05/22/2023\nRIP: 0010:refcount_warn_saturate+0xe5/0x110\nCode: 42 8e ff 0f 0b c3 cc cc cc cc 80 3d aa 13 ea 01 00 0f 85 5e ff ff ff 48 c7 c7 f8 8e b7 82 c6 05 96 13 ea 01 01 e8 7b 42 8e ff <0f> 0b c3 cc cc cc cc 48 c7 c7 50 8f b7 82 c6 05 7a 13 ea 01 01 e8\nRSP: 0018:ffffc90006b43b60 EFLAGS: 00010282\nRAX: 0000000000000000 RBX: ffff888009bb3ef0 RCX: 0000000000000027\nRDX: ffff88807be218c8 RSI: 0000000000000001 RDI: ffff88807be218c0\nRBP: 0000000000069d70 R08: 0000000000000000 R09: ffffc90006b439f0\nR10: ffffc90006b439e8 R11: 0000000000000003 R12: ffff8880029ede84\nR13: 0000000000004e20 R14: ffffffff84356dc0 R15: ffff888009bb3ef0\nFS:  00007f62c10926c0(0000) GS:ffff88807be00000(0000) knlGS:0000000000000000\nCS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033\nCR2: 0000000020ccb000 CR3: 000000004628c005 CR4: 0000000000f70ef0\nPKRU: 55555554\nCall Trace:\n <TASK>\n ? refcount_warn_saturate+0xe5/0x110\n ? __warn+0x81/0x130\n ? refcount_warn_saturate+0xe5/0x110\n ? report_bug+0x171/0x1a0\n ? refcount_warn_saturate+0xe5/0x110\n ? handle_bug+0x3c/0x80\n ? exc_invalid_op+0x17/0x70\n ? asm_exc_invalid_op+0x1a/0x20\n ? refcount_warn_saturate+0xe5/0x110\n tcp_twsk_unique+0x186/0x190\n __inet_check_established+0x176/0x2d0\n __inet_hash_connect+0x74/0x7d0\n ? __pfx___inet_check_established+0x10/0x10\n tcp_v4_connect+0x278/0x530\n __inet_stream_connect+0x10f/0x3d0\n inet_stream_connect+0x3a/0x60\n __sys_connect+0xa8/0xd0\n __x64_sys_connect+0x18/0x20\n do_syscall_64+0x83/0x170\n entry_SYSCALL_64_after_hwframe+0x78/0x80\nRIP: 0033:0x7f62c11a885d\nCode: ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d a3 45 0c 00 f7 d8 64 89 01 48\nRSP: 002b:00007f62c1091e58 EFLAGS: 00000296 ORIG_RAX: 000000000000002a\nRAX: ffffffffffffffda RBX: 0000000020ccb004 RCX: 00007f62c11a885d\nRDX: 0000000000000010 RSI: 0000000020ccb000 RDI: 0000000000000003\nRBP: 00007f62c1091e90 R08: 0000000000000000 R09: 0000000000000000\nR10: 0000000000000000 R11: 0000000000000296 R12: 00007f62c10926c0\nR13: ffffffffffffff88 R14: 0000000000000000 R15: 00007ffe237885b0\n </TASK>"}, {"lang": "es", "value": "En el kernel de Linux se ha resuelto la siguiente vulnerabilidad: tcp: utilice refcount_inc_not_zero() en tcp_twsk_unique(). Anderson Nascimento inform\u00f3 sobre un s\u00edmbolo de use after free en tcp_twsk_unique() con un buen an\u00e1lisis. Desde el commit ec94c2696f0b (\"tcp/dccp: evitar una operaci\u00f3n at\u00f3mica para timewait hashdance\"), inet_twsk_hashdance() establece el sk_refcnt del socket TIME-WAIT despu\u00e9s de ponerlo en ehash y liberar el bloqueo del dep\u00f3sito. Por lo tanto, hay una peque\u00f1a ventana de ejecuci\u00f3n donde otros subprocesos podr\u00edan intentar reutilizar el puerto durante connect() y llamar a sock_hold() en tcp_twsk_unique() para el socket TIME-WAIT con cero refcnt. Si eso sucede, el refcnt tomado por tcp_twsk_unique() se sobrescribe y sock_put() provocar\u00e1 un desbordamiento insuficiente, lo que desencadenar\u00e1 un use after free real en otro lugar. Para evitar el use after free, debemos usar refcount_inc_not_zero() en tcp_twsk_unique() y renunciar a reutilizar el puerto si devuelve falso. [0]: refcount_t: suma en 0; use after free. ADVERTENCIA: CPU: 0 PID: 1039313 en lib/refcount.c:25 refcount_warn_saturate+0xe5/0x110 CPU: 0 PID: 1039313 Comm: disparador No contaminado 6.8.6-200.fc39.x86_64 #1 Nombre de hardware: VMware, Inc. Plataforma de referencia de escritorio VMware20,1/440BX, BIOS VMW201.00V.21805430.B64.2305221830 22/05/2023 RIP: 0010:refcount_warn_saturate+0xe5/0x110 C\u00f3digo: 42 8e ff 0f 0b c3 cc cc cc 80 3d aa 13 cada uno 01 00 0f 85 5e ff ff 48 c7 c7 f8 8e b7 82 c6 05 96 13 ea 01 01 e8 7b 42 8e ff &lt;0f&gt; 0b c3 cc cc cc cc 48 c7 c7 50 8f b7 82 c6 05 7a 13 ea 0 1 e8 RSP: 0018:ffffc90006b43b60 EFLAGS: 00010282 RAX: 0000000000000000 RBX: ffff888009bb3ef0 RCX: 00000000000000027 RDX: ffff88807be218c8 RSI: 00000000001 RDI: ffff88807be218c0 RBP: 0000000000069d70 R08: 0000000000000000 R09: ffffc90006b439f0 R10: ffffc90006b439e8 R11: 000000000000 0003 R12: ffff8880029ede84 R13: 0000000000004e20 R14: ffffffff84356dc0 R15: ffff888009bb3ef0 FS: 00007f62c10926c0(0000) GS:ffff88807be00000(0000) knlGS:00000000000000000 CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033 CR2: 0000000020ccb000 CR3: 000000004628c005 CR4: 0000000000f70ef0 PKRU: 55555554 Seguimiento de llamadas:  ? refcount_warn_saturate+0xe5/0x110? __advertir+0x81/0x130 ? refcount_warn_saturate+0xe5/0x110? report_bug+0x171/0x1a0? refcount_warn_saturate+0xe5/0x110? handle_bug+0x3c/0x80? exc_invalid_op+0x17/0x70? asm_exc_invalid_op+0x1a/0x20? refcount_warn_saturate+0xe5/0x110 tcp_twsk_unique+0x186/0x190 __inet_check_establecido+0x176/0x2d0 __inet_hash_connect+0x74/0x7d0 ? __pfx___inet_check_establecido+0x10/0x10 tcp_v4_connect+0x278/0x530 __inet_stream_connect+0x10f/0x3d0 inet_stream_connect+0x3a/0x60 __sys_connect+0xa8/0xd0 __x64_sys_connect+0x18/0x20 _64+0x83/0x170 entrada_SYSCALL_64_after_hwframe+0x78/0x80 RIP: 0033:0x7f62c11a885d C\u00f3digo: ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 &lt;48&gt; 3d 01 f0 ff 73 01 c3 48 8b 0d a3 45 0c 00 f7 d8 64 89 01 48 RSP: 002b:00007f62c1091e58 EFLAGS: 00000296 ORIG_RAX: 0000000000000002a RAX: ffffffffffffffda RBX: 20ccb004 RCX: 00007f62c11a885d RDX: 00000000000000010 RSI: 0000000020ccb000 RDI: 0000000000000003 RBP: 00007f62c1091e90 R08: 0000000000000 0000R09: 0000000000000000 R10: 0000000000000000 R11: 0000000000000296 R12: 00007f62c10926c0 R13: ffffffffffffff88 R14: 0000000000000000 R15: 07ffe237885b0 "}]}, "references": {"reference_data": [{"url": "https://git.kernel.org/stable/c/13ed7cdf079686ccd3618335205700c03f6fb446", "name": "", "refsource": "", "tags": []}, {"url": "https://git.kernel.org/stable/c/1796ca9c6f5bd50554214053af5f47d112818ee3", "name": "", "refsource": "", "tags": []}, {"url": "https://git.kernel.org/stable/c/1d9cf07810c30ef7948879567d10fd1f01121d34", "name": "", "refsource": "", "tags": []}, {"url": "https://git.kernel.org/stable/c/27b0284d8be182a81feb65581ab6a724dfd596e8", "name": "", "refsource": "", "tags": []}, {"url": "https://git.kernel.org/stable/c/517e32ea0a8c72202d0d8aa8df50a7cd3d6fdefc", "name": "", "refsource": "", "tags": []}, {"url": "https://git.kernel.org/stable/c/6e48faad92be13166184d21506e4e54c79c13adc", "name": "", "refsource": "", "tags": []}, {"url": "https://git.kernel.org/stable/c/84546cc1aeeb4df3e444b18a4293c9823f974be9", "name": "", "refsource": "", "tags": []}, {"url": "https://git.kernel.org/stable/c/f2db7230f73a80dbb179deab78f88a7947f0ab7e", "name": "", "refsource": "", "tags": []}, {"url": "https://git.kernel.org/stable/c/13ed7cdf079686ccd3618335205700c03f6fb446", "name": "", "refsource": "", "tags": []}, {"url": "https://git.kernel.org/stable/c/1796ca9c6f5bd50554214053af5f47d112818ee3", "name": "", "refsource": "", "tags": []}, {"url": "https://git.kernel.org/stable/c/1d9cf07810c30ef7948879567d10fd1f01121d34", "name": "", "refsource": "", "tags": []}, {"url": "https://git.kernel.org/stable/c/27b0284d8be182a81feb65581ab6a724dfd596e8", "name": "", "refsource": "", "tags": []}, {"url": "https://git.kernel.org/stable/c/517e32ea0a8c72202d0d8aa8df50a7cd3d6fdefc", "name": "", "refsource": "", "tags": []}, {"url": "https://git.kernel.org/stable/c/6e48faad92be13166184d21506e4e54c79c13adc", "name": "", "refsource": "", "tags": []}, {"url": "https://git.kernel.org/stable/c/84546cc1aeeb4df3e444b18a4293c9823f974be9", "name": "", "refsource": "", "tags": []}, {"url": "https://git.kernel.org/stable/c/f2db7230f73a80dbb179deab78f88a7947f0ab7e", "name": "", "refsource": "", "tags": []}, {"url": "https://lists.debian.org/debian-lts-announce/2024/06/msg00019.html", "name": "", "refsource": "", "tags": []}, {"url": "https://lists.debian.org/debian-lts-announce/2024/06/msg00020.html", "name": "", "refsource": "", "tags": []}, {"url": "https://security.netapp.com/advisory/ntap-20240905-0004/", "name": "", "refsource": "", "tags": []}]}, "problemtype": {"problemtype_data": [{"description": [{"lang": "en", "value": "NVD-CWE-noinfo"}]}]}}, "impact": {}, "configurations": {"CVE_data_version": "4.0", "nodes": []}}