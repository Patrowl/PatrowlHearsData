{"id": "EUVD-2022-54625", "enisaUuid": "8dd1fac2-ddd8-3e27-84ee-9707c0afc1de", "description": "In the Linux kernel, the following vulnerability has been resolved:\n\nperf/core: Fix data race between perf_event_set_output() and perf_mmap_close()\n\nYang Jihing reported a race between perf_event_set_output() and\nperf_mmap_close():\n\n\tCPU1\t\t\t\t\tCPU2\n\n\tperf_mmap_close(e2)\n\t  if (atomic_dec_and_test(&e2->rb->mmap_count)) // 1 - > 0\n\t    detach_rest = true\n\n\t\t\t\t\t\tioctl(e1, IOC_SET_OUTPUT, e2)\n\t\t\t\t\t\t  perf_event_set_output(e1, e2)\n\n\t  ...\n\t  list_for_each_entry_rcu(e, &e2->rb->event_list, rb_entry)\n\t    ring_buffer_attach(e, NULL);\n\t    // e1 isn't yet added and\n\t    // therefore not detached\n\n\t\t\t\t\t\t    ring_buffer_attach(e1, e2->rb)\n\t\t\t\t\t\t      list_add_rcu(&e1->rb_entry,\n\t\t\t\t\t\t\t\t   &e2->rb->event_list)\n\nAfter this; e1 is attached to an unmapped rb and a subsequent\nperf_mmap() will loop forever more:\n\n\tagain:\n\t\tmutex_lock(&e->mmap_mutex);\n\t\tif (event->rb) {\n\t\t\t...\n\t\t\tif (!atomic_inc_not_zero(&e->rb->mmap_count)) {\n\t\t\t\t...\n\t\t\t\tmutex_unlock(&e->mmap_mutex);\n\t\t\t\tgoto again;\n\t\t\t}\n\t\t}\n\nThe loop in perf_mmap_close() holds e2->mmap_mutex, while the attach\nin perf_event_set_output() holds e1->mmap_mutex. As such there is no\nserialization to avoid this race.\n\nChange perf_event_set_output() to take both e1->mmap_mutex and\ne2->mmap_mutex to alleviate that problem. Additionally, have the loop\nin perf_mmap() detach the rb directly, this avoids having to wait for\nthe concurrent perf_mmap_close() to get around to doing it to make\nprogress.", "datePublished": "2025-02-26T02:23:31", "dateUpdated": "2025-10-01T19:36:51", "baseScore": 4.7, "baseScoreVersion": "3.1", "baseScoreVector": "CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:H", "references": ["https://git.kernel.org/stable/c/3bbd868099287ff9027db59029b502fcfa2202a0", "https://git.kernel.org/stable/c/f836f9ac95df15f1e0af4beb0ec20021e8c91998", "https://git.kernel.org/stable/c/17f5417194136517ee9bbd6511249e5310e5617c", "https://git.kernel.org/stable/c/98c3c8fd0d4c560e0f8335b79c407bbf7fc9462c", "https://git.kernel.org/stable/c/43128b3eee337824158f34da6648163d2f2fb937", "https://git.kernel.org/stable/c/da3c256e2d0ebc87c7db0c605c9692b6f1722074", "https://git.kernel.org/stable/c/a9391ff7a7c5f113d6f2bf6621d49110950de49c", "https://git.kernel.org/stable/c/68e3c69803dada336893640110cb87221bb01dcf"], "aliases": ["CVE-2022-49607"], "assigner": "Linux", "epss": 0.03, "enisaIdProduct": [{"id": "19e99480-76b8-3a61-a294-6a5bfef48adc", "product": {"name": "Linux"}, "product_version": "patch: 5.19"}, {"id": "1e8b2b23-5749-389c-a945-2c8610b6ec53", "product": {"name": "Linux"}, "product_version": "c52217e88ae0f3a4ae00562d86e338f8f85969b4"}, {"id": "260fa380-ccfa-3b4c-9da8-7d6d6e51ddd5", "product": {"name": "Linux"}, "product_version": "patch: 4.19.254"}, {"id": "310114d6-4fec-371e-a387-7c1dbff02b27", "product": {"name": "Linux"}, "product_version": "patch: 0"}, {"id": "35692861-c59f-3811-ad3a-5ce6d3484dbe", "product": {"name": "Linux"}, "product_version": "2487f0db30527032c4d56fc2d0b1a240fe89fef8"}, {"id": "3a5dbb1d-7ead-3166-a8e8-5d78e8a8ca09", "product": {"name": "Linux"}, "product_version": "3.10"}, {"id": "44c32f58-5efd-3075-88ba-ba37f6da08f1", "product": {"name": "Linux"}, "product_version": "9bb5d40cd93c9dd4be74834b1dcb1ba03629716b <98c3c8fd0d4c560e0f8335b79c407bbf7fc9462c"}, {"id": "44fcf82a-c519-336f-a021-4511a1812e0c", "product": {"name": "Linux"}, "product_version": "patch: 4.9.325"}, {"id": "5219c753-0d33-3ce8-b4af-7a9683810e94", "product": {"name": "Linux"}, "product_version": "9bb5d40cd93c9dd4be74834b1dcb1ba03629716b <f836f9ac95df15f1e0af4beb0ec20021e8c91998"}, {"id": "6ef16268-fd83-3c6d-97a4-ae31331b95f4", "product": {"name": "Linux"}, "product_version": "patch: 5.10.134"}, {"id": "8b17877f-90fd-36b7-a55e-b714dbb3d1a7", "product": {"name": "Linux"}, "product_version": "9bb5d40cd93c9dd4be74834b1dcb1ba03629716b <da3c256e2d0ebc87c7db0c605c9692b6f1722074"}, {"id": "9b01c1f4-7a55-331b-91f4-b1a1ff4837a8", "product": {"name": "Linux"}, "product_version": "patch: 5.15.58"}, {"id": "9d0408ad-aed4-38ed-ae64-56baaefe422e", "product": {"name": "Linux"}, "product_version": "703197b61d05f5edae54bad3256901c5a5c8794c"}, {"id": "9ed748a6-a6d3-3bfd-97a8-c036ac12e0c2", "product": {"name": "Linux"}, "product_version": "9bb5d40cd93c9dd4be74834b1dcb1ba03629716b <a9391ff7a7c5f113d6f2bf6621d49110950de49c"}, {"id": "b3de8739-f7f0-36fe-abe4-c9a4c94971df", "product": {"name": "Linux"}, "product_version": "9bb5d40cd93c9dd4be74834b1dcb1ba03629716b <17f5417194136517ee9bbd6511249e5310e5617c"}, {"id": "b6326218-f6b7-3a13-9e17-d0eddf9454da", "product": {"name": "Linux"}, "product_version": "9bb5d40cd93c9dd4be74834b1dcb1ba03629716b <43128b3eee337824158f34da6648163d2f2fb937"}, {"id": "be98b18f-99e5-3797-b382-9d86ca4c05f9", "product": {"name": "Linux"}, "product_version": "9bb5d40cd93c9dd4be74834b1dcb1ba03629716b <68e3c69803dada336893640110cb87221bb01dcf"}, {"id": "dab37df4-c732-3745-9552-660e3e7031d6", "product": {"name": "Linux"}, "product_version": "9bb5d40cd93c9dd4be74834b1dcb1ba03629716b <3bbd868099287ff9027db59029b502fcfa2202a0"}, {"id": "e2d825eb-3714-3fce-8f4e-23b7a164b3bf", "product": {"name": "Linux"}, "product_version": "patch: 5.18.15"}, {"id": "ebb417e3-bb20-3a0d-9138-571d324778f9", "product": {"name": "Linux"}, "product_version": "patch: 4.14.290"}, {"id": "f6c17615-baf4-3d71-a57b-80a0315f55c7", "product": {"name": "Linux"}, "product_version": "patch: 5.4.208"}], "enisaIdVendor": [{"id": "5ddbc127-5f94-3d67-a693-3f5ffd9a1498", "vendor": {"name": "Linux"}}], "isExploited": false}