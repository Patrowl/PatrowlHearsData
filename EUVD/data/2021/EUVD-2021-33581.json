{"id": "EUVD-2021-33581", "enisaUuid": "6d7395e6-3715-3851-ad99-e69b8e4b4de4", "description": "In the Linux kernel, the following vulnerability has been resolved:\n\nusb: gadget: f_fs: Clear ffs_eventfd in ffs_data_clear.\n\nffs_data_clear is indirectly called from both ffs_fs_kill_sb and\nffs_ep0_release, so it ends up being called twice when userland closes ep0\nand then unmounts f_fs.\nIf userland provided an eventfd along with function's USB descriptors, it\nends up calling eventfd_ctx_put as many times, causing a refcount\nunderflow.\nNULL-ify ffs_eventfd to prevent these extraneous eventfd_ctx_put calls.\n\nAlso, set epfiles to NULL right after de-allocating it, for readability.\n\nFor completeness, ffs_data_clear actually ends up being called thrice, the\nlast call being before the whole ffs structure gets freed, so when this\nspecific sequence happens there is a second underflow happening (but not\nbeing reported):\n\n/sys/kernel/debug/tracing# modprobe usb_f_fs\n/sys/kernel/debug/tracing# echo ffs_data_clear > set_ftrace_filter\n/sys/kernel/debug/tracing# echo function > current_tracer\n/sys/kernel/debug/tracing# echo 1 > tracing_on\n(setup gadget, run and kill function userland process, teardown gadget)\n/sys/kernel/debug/tracing# echo 0 > tracing_on\n/sys/kernel/debug/tracing# cat trace\n smartcard-openp-436     [000] .....  1946.208786: ffs_data_clear <-ffs_data_closed\n smartcard-openp-431     [000] .....  1946.279147: ffs_data_clear <-ffs_data_closed\n smartcard-openp-431     [000] .n...  1946.905512: ffs_data_clear <-ffs_data_put\n\nWarning output corresponding to above trace:\n[ 1946.284139] WARNING: CPU: 0 PID: 431 at lib/refcount.c:28 refcount_warn_saturate+0x110/0x15c\n[ 1946.293094] refcount_t: underflow; use-after-free.\n[ 1946.298164] Modules linked in: usb_f_ncm(E) u_ether(E) usb_f_fs(E) hci_uart(E) btqca(E) btrtl(E) btbcm(E) btintel(E) bluetooth(E) nls_ascii(E) nls_cp437(E) vfat(E) fat(E) bcm2835_v4l2(CE) bcm2835_mmal_vchiq(CE) videobuf2_vmalloc(E) videobuf2_memops(E) sha512_generic(E) videobuf2_v4l2(E) sha512_arm(E) videobuf2_common(E) videodev(E) cpufreq_dt(E) snd_bcm2835(CE) brcmfmac(E) mc(E) vc4(E) ctr(E) brcmutil(E) snd_soc_core(E) snd_pcm_dmaengine(E) drbg(E) snd_pcm(E) snd_timer(E) snd(E) soundcore(E) drm_kms_helper(E) cec(E) ansi_cprng(E) rc_core(E) syscopyarea(E) raspberrypi_cpufreq(E) sysfillrect(E) sysimgblt(E) cfg80211(E) max17040_battery(OE) raspberrypi_hwmon(E) fb_sys_fops(E) regmap_i2c(E) ecdh_generic(E) rfkill(E) ecc(E) bcm2835_rng(E) rng_core(E) vchiq(CE) leds_gpio(E) libcomposite(E) fuse(E) configfs(E) ip_tables(E) x_tables(E) autofs4(E) ext4(E) crc16(E) mbcache(E) jbd2(E) crc32c_generic(E) sdhci_iproc(E) sdhci_pltfm(E) sdhci(E)\n[ 1946.399633] CPU: 0 PID: 431 Comm: smartcard-openp Tainted: G         C OE     5.15.0-1-rpi #1  Debian 5.15.3-1\n[ 1946.417950] Hardware name: BCM2835\n[ 1946.425442] Backtrace:\n[ 1946.432048] [<c08d60a0>] (dump_backtrace) from [<c08d62ec>] (show_stack+0x20/0x24)\n[ 1946.448226]  r7:00000009 r6:0000001c r5:c04a948c r4:c0a64e2c\n[ 1946.458412] [<c08d62cc>] (show_stack) from [<c08d9ae0>] (dump_stack+0x28/0x30)\n[ 1946.470380] [<c08d9ab8>] (dump_stack) from [<c0123500>] (__warn+0xe8/0x154)\n[ 1946.482067]  r5:c04a948c r4:c0a71dc8\n[ 1946.490184] [<c0123418>] (__warn) from [<c08d6948>] (warn_slowpath_fmt+0xa0/0xe4)\n[ 1946.506758]  r7:00000009 r6:0000001c r5:c0a71dc8 r4:c0a71e04\n[ 1946.517070] [<c08d68ac>] (warn_slowpath_fmt) from [<c04a948c>] (refcount_warn_saturate+0x110/0x15c)\n[ 1946.535309]  r8:c0100224 r7:c0dfcb84 r6:ffffffff r5:c3b84c00 r4:c24a17c0\n[ 1946.546708] [<c04a937c>] (refcount_warn_saturate) from [<c0380134>] (eventfd_ctx_put+0x48/0x74)\n[ 1946.564476] [<c03800ec>] (eventfd_ctx_put) from [<bf5464e8>] (ffs_data_clear+0xd0/0x118 [usb_f_fs])\n[ 1946.582664]  r5:c3b84c00 r4:c2695b00\n[ 1946.590668] [<bf546418>] (ffs_data_clear [usb_f_fs]) from [<bf547cc0>] (ffs_data_closed+0x9c/0x150 [usb_f_fs])\n[ 1946.609608]  r5:bf54d014 r4:c2695b00\n[ 1946.617522] [<bf547c24>] (ffs_data_closed [usb_f_fs]) from [<bf547da0>] (ffs_fs_kill_sb+0x2c/0x30 [usb_f_fs])\n[ 1946.636217]  r7:c0dfcb\n---truncated---", "datePublished": "2024-02-27T09:44:00", "dateUpdated": "2025-04-22T16:12:28", "baseScore": 5.5, "baseScoreVersion": "3.1", "baseScoreVector": "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H", "references": ["https://git.kernel.org/stable/c/f976dd7011150244a7ba820f2c331e9fb253befa", "https://git.kernel.org/stable/c/cc8c8028c21b2a3842a1e98e99e55028df275919", "https://git.kernel.org/stable/c/52500239e3f2d6fc77b6f58632a9fb98fe74ac09", "https://git.kernel.org/stable/c/33f6a0cbb7772146e1c11f38028fffbfed14728b", "https://git.kernel.org/stable/c/240fc586e83d645912accce081a48aa63a45f6ee", "https://git.kernel.org/stable/c/1c4ace3e6b8575745c50dca9e76e0021e697d645", "https://git.kernel.org/stable/c/ebef2aa29f370b5096c16020c104e393192ef684", "https://git.kernel.org/stable/c/b1e0887379422975f237d43d8839b751a6bcf154"], "aliases": ["CVE-2021-46933"], "assigner": "Linux", "epss": 0.02, "enisaIdProduct": [{"id": "09ff752a-09da-3db8-9d33-6f7007138cc3", "product": {"name": "Linux"}, "product_version": "5e33f6fdf735cda1d4580fe6f1878da05718fe73 <ebef2aa29f370b5096c16020c104e393192ef684"}, {"id": "296df437-18de-3160-a67a-227e13172da5", "product": {"name": "Linux"}, "product_version": "patch: 4.4.298"}, {"id": "2ba9fc5f-9619-315e-a8f6-2528141179d1", "product": {"name": "Linux"}, "product_version": "patch: 4.14.261"}, {"id": "3ad398a7-4ea0-30ad-82b2-0e14daf95f2f", "product": {"name": "Linux"}, "product_version": "patch: 5.4.170"}, {"id": "430ce750-f621-3635-9b84-f094846915dd", "product": {"name": "Linux"}, "product_version": "patch: 4.9.296"}, {"id": "51e5eefc-7d13-3218-860d-dde111b37b86", "product": {"name": "Linux"}, "product_version": "5e33f6fdf735cda1d4580fe6f1878da05718fe73 <f976dd7011150244a7ba820f2c331e9fb253befa"}, {"id": "6201a319-92d7-33cf-82cc-fecac63b88a9", "product": {"name": "Linux"}, "product_version": "5e33f6fdf735cda1d4580fe6f1878da05718fe73 <33f6a0cbb7772146e1c11f38028fffbfed14728b"}, {"id": "84138974-0737-3618-8260-9dc673097bcb", "product": {"name": "Linux"}, "product_version": "5e33f6fdf735cda1d4580fe6f1878da05718fe73 <52500239e3f2d6fc77b6f58632a9fb98fe74ac09"}, {"id": "87c1f547-c138-3ec0-8426-d67f2b1fa99f", "product": {"name": "Linux"}, "product_version": "patch: 4.19.224"}, {"id": "95b9fe6e-2e87-3bea-aaae-62789271ea5e", "product": {"name": "Linux"}, "product_version": "5e33f6fdf735cda1d4580fe6f1878da05718fe73 <1c4ace3e6b8575745c50dca9e76e0021e697d645"}, {"id": "acd1ea83-6fc7-3982-bd26-f6b22068bc1c", "product": {"name": "Linux"}, "product_version": "4.0"}, {"id": "b4b44d9e-1b3d-35fb-a49e-c964d3493d34", "product": {"name": "Linux"}, "product_version": "patch: 5.16"}, {"id": "b625b39e-9bf2-3003-9b6c-9f947bc53a32", "product": {"name": "Linux"}, "product_version": "patch: 5.10.90"}, {"id": "b6ef17ca-1e07-3e50-8cbd-cf22fddbdf04", "product": {"name": "Linux"}, "product_version": "5e33f6fdf735cda1d4580fe6f1878da05718fe73 <240fc586e83d645912accce081a48aa63a45f6ee"}, {"id": "d8c4727b-c7ed-3fae-80d0-c873800a9dff", "product": {"name": "Linux"}, "product_version": "patch: 0"}, {"id": "e298485e-89da-31e4-918a-1b92f66394d5", "product": {"name": "Linux"}, "product_version": "5e33f6fdf735cda1d4580fe6f1878da05718fe73 <b1e0887379422975f237d43d8839b751a6bcf154"}, {"id": "e593095e-09de-3938-bc8a-c6a3a715bd93", "product": {"name": "Linux"}, "product_version": "5e33f6fdf735cda1d4580fe6f1878da05718fe73 <cc8c8028c21b2a3842a1e98e99e55028df275919"}, {"id": "f8d3b5f9-ac6d-37d6-b2d8-b97b8455d86a", "product": {"name": "Linux"}}, {"id": "fbc33bb9-4457-35e4-9a91-9a3f20e6bf40", "product": {"name": "Linux"}, "product_version": "patch: 5.15.13"}], "enisaIdVendor": [{"id": "f8d3b5f9-ac6d-37d6-b2d8-b97b8455d86a", "vendor": {"name": "Linux"}}], "isExploited": false}