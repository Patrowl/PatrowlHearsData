{"id": "EUVD-2024-54030", "enisaUuid": "63ab0dae-387c-3c85-8876-5e43712c51c9", "description": "In the Linux kernel, the following vulnerability has been resolved:\n\nbpf: bpf_local_storage: Always use bpf_mem_alloc in PREEMPT_RT\n\nIn PREEMPT_RT, kmalloc(GFP_ATOMIC) is still not safe in non preemptible\ncontext. bpf_mem_alloc must be used in PREEMPT_RT. This patch is\nto enforce bpf_mem_alloc in the bpf_local_storage when CONFIG_PREEMPT_RT\nis enabled.\n\n[   35.118559] BUG: sleeping function called from invalid context at kernel/locking/spinlock_rt.c:48\n[   35.118566] in_atomic(): 1, irqs_disabled(): 0, non_block: 0, pid: 1832, name: test_progs\n[   35.118569] preempt_count: 1, expected: 0\n[   35.118571] RCU nest depth: 1, expected: 1\n[   35.118577] INFO: lockdep is turned off.\n    ...\n[   35.118647]  __might_resched+0x433/0x5b0\n[   35.118677]  rt_spin_lock+0xc3/0x290\n[   35.118700]  ___slab_alloc+0x72/0xc40\n[   35.118723]  __kmalloc_noprof+0x13f/0x4e0\n[   35.118732]  bpf_map_kzalloc+0xe5/0x220\n[   35.118740]  bpf_selem_alloc+0x1d2/0x7b0\n[   35.118755]  bpf_local_storage_update+0x2fa/0x8b0\n[   35.118784]  bpf_sk_storage_get_tracing+0x15a/0x1d0\n[   35.118791]  bpf_prog_9a118d86fca78ebb_trace_inet_sock_set_state+0x44/0x66\n[   35.118795]  bpf_trace_run3+0x222/0x400\n[   35.118820]  __bpf_trace_inet_sock_set_state+0x11/0x20\n[   35.118824]  trace_inet_sock_set_state+0x112/0x130\n[   35.118830]  inet_sk_state_store+0x41/0x90\n[   35.118836]  tcp_set_state+0x3b3/0x640\n\nThere is no need to adjust the gfp_flags passing to the\nbpf_mem_cache_alloc_flags() which only honors the GFP_KERNEL.\nThe verifier has ensured GFP_KERNEL is passed only in sleepable context.\n\nIt has been an old issue since the first introduction of the\nbpf_local_storage ~5 years ago, so this patch targets the bpf-next.\n\nbpf_mem_alloc is needed to solve it, so the Fixes tag is set\nto the commit when bpf_mem_alloc was first used in the bpf_local_storage.", "datePublished": "2025-03-06T15:54:10", "dateUpdated": "2025-10-01T19:36:36", "baseScore": 5.5, "baseScoreVersion": "3.1", "baseScoreVector": "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H", "references": ["https://git.kernel.org/stable/c/3392fa605d7c5708c5fbe02e4fbdac547c3b7352", "https://git.kernel.org/stable/c/b0027500000dfcb8ee952557d565064cea22c43e", "https://git.kernel.org/stable/c/c1d398a3af7e59d7fef351c84fed7ebb575d1f1a", "https://git.kernel.org/stable/c/8eef6ac4d70eb1f0099fff93321d90ce8fa49ee1"], "aliases": ["CVE-2024-58070"], "assigner": "Linux", "epss": 0.03, "enisaIdProduct": [{"id": "1824276d-1fa1-39ed-bc27-b15b9518db9d", "product": {"name": "Linux"}, "product_version": "08a7ce384e33e53e0732c500a8af67a73f8fceca <c1d398a3af7e59d7fef351c84fed7ebb575d1f1a"}, {"id": "2162a7e2-24f6-37db-9d7d-5c3d6afe1f72", "product": {"name": "Linux"}, "product_version": "patch: 6.13.2"}, {"id": "330562ea-5431-3df1-9932-911e0887ad2e", "product": {"name": "Linux"}, "product_version": "patch: 6.12.13"}, {"id": "6a261ffd-33ad-3ff9-9d79-3849ab32944c", "product": {"name": "Linux"}, "product_version": "patch: 6.6.76"}, {"id": "93fa8116-9351-36d4-bad3-09b429aa68a6", "product": {"name": "Linux"}, "product_version": "6.4"}, {"id": "9a1888b3-63e4-316b-9602-41452112280e", "product": {"name": "Linux"}, "product_version": "08a7ce384e33e53e0732c500a8af67a73f8fceca <b0027500000dfcb8ee952557d565064cea22c43e"}, {"id": "9ea71447-cf29-3ce9-a236-9dac3f3a8f47", "product": {"name": "Linux"}, "product_version": "patch: 6.14"}, {"id": "adf888b7-9261-315e-b82f-c8d0b71c5892", "product": {"name": "Linux"}, "product_version": "08a7ce384e33e53e0732c500a8af67a73f8fceca <3392fa605d7c5708c5fbe02e4fbdac547c3b7352"}, {"id": "b1ae2947-f3ec-311f-8625-cc5a891284a2", "product": {"name": "Linux"}, "product_version": "08a7ce384e33e53e0732c500a8af67a73f8fceca <8eef6ac4d70eb1f0099fff93321d90ce8fa49ee1"}, {"id": "cbc6f3f5-c6a3-3a2f-8da3-e1ccabd4c0bc", "product": {"name": "Linux"}, "product_version": "patch: 0"}], "enisaIdVendor": [{"id": "750c2555-4d77-360d-afa8-5e7a85a3cd3a", "vendor": {"name": "Linux"}}], "isExploited": false}