{"id": "EUVD-2024-45151", "enisaUuid": "10bc6384-52f9-3694-a278-2c053756e6cd", "description": "In the Linux kernel, the following vulnerability has been resolved:\n\ntcp/dccp: Don't use timer_pending() in reqsk_queue_unlink().\n\nMartin KaFai Lau reported use-after-free [0] in reqsk_timer_handler().\n\n  \"\"\"\n  We are seeing a use-after-free from a bpf prog attached to\n  trace_tcp_retransmit_synack. The program passes the req->sk to the\n  bpf_sk_storage_get_tracing kernel helper which does check for null\n  before using it.\n  \"\"\"\n\nThe commit 83fccfc3940c (\"inet: fix potential deadlock in\nreqsk_queue_unlink()\") added timer_pending() in reqsk_queue_unlink() not\nto call del_timer_sync() from reqsk_timer_handler(), but it introduced a\nsmall race window.\n\nBefore the timer is called, expire_timers() calls detach_timer(timer, true)\nto clear timer->entry.pprev and marks it as not pending.\n\nIf reqsk_queue_unlink() checks timer_pending() just after expire_timers()\ncalls detach_timer(), TCP will miss del_timer_sync(); the reqsk timer will\ncontinue running and send multiple SYN+ACKs until it expires.\n\nThe reported UAF could happen if req->sk is close()d earlier than the timer\nexpiration, which is 63s by default.\n\nThe scenario would be\n\n  1. inet_csk_complete_hashdance() calls inet_csk_reqsk_queue_drop(),\n     but del_timer_sync() is missed\n\n  2. reqsk timer is executed and scheduled again\n\n  3. req->sk is accept()ed and reqsk_put() decrements rsk_refcnt, but\n     reqsk timer still has another one, and inet_csk_accept() does not\n     clear req->sk for non-TFO sockets\n\n  4. sk is close()d\n\n  5. reqsk timer is executed again, and BPF touches req->sk\n\nLet's not use timer_pending() by passing the caller context to\n__inet_csk_reqsk_queue_drop().\n\nNote that reqsk timer is pinned, so the issue does not happen in most\nuse cases. [1]\n\n[0]\nBUG: KFENCE: use-after-free read in bpf_sk_storage_get_tracing+0x2e/0x1b0\n\nUse-after-free read at 0x00000000a891fb3a (in kfence-#1):\nbpf_sk_storage_get_tracing+0x2e/0x1b0\nbpf_prog_5ea3e95db6da0438_tcp_retransmit_synack+0x1d20/0x1dda\nbpf_trace_run2+0x4c/0xc0\ntcp_rtx_synack+0xf9/0x100\nreqsk_timer_handler+0xda/0x3d0\nrun_timer_softirq+0x292/0x8a0\nirq_exit_rcu+0xf5/0x320\nsysvec_apic_timer_interrupt+0x6d/0x80\nasm_sysvec_apic_timer_interrupt+0x16/0x20\nintel_idle_irq+0x5a/0xa0\ncpuidle_enter_state+0x94/0x273\ncpu_startup_entry+0x15e/0x260\nstart_secondary+0x8a/0x90\nsecondary_startup_64_no_verify+0xfa/0xfb\n\nkfence-#1: 0x00000000a72cc7b6-0x00000000d97616d9, size=2376, cache=TCPv6\n\nallocated by task 0 on cpu 9 at 260507.901592s:\nsk_prot_alloc+0x35/0x140\nsk_clone_lock+0x1f/0x3f0\ninet_csk_clone_lock+0x15/0x160\ntcp_create_openreq_child+0x1f/0x410\ntcp_v6_syn_recv_sock+0x1da/0x700\ntcp_check_req+0x1fb/0x510\ntcp_v6_rcv+0x98b/0x1420\nipv6_list_rcv+0x2258/0x26e0\nnapi_complete_done+0x5b1/0x2990\nmlx5e_napi_poll+0x2ae/0x8d0\nnet_rx_action+0x13e/0x590\nirq_exit_rcu+0xf5/0x320\ncommon_interrupt+0x80/0x90\nasm_common_interrupt+0x22/0x40\ncpuidle_enter_state+0xfb/0x273\ncpu_startup_entry+0x15e/0x260\nstart_secondary+0x8a/0x90\nsecondary_startup_64_no_verify+0xfa/0xfb\n\nfreed by task 0 on cpu 9 at 260507.927527s:\nrcu_core_si+0x4ff/0xf10\nirq_exit_rcu+0xf5/0x320\nsysvec_apic_timer_interrupt+0x6d/0x80\nasm_sysvec_apic_timer_interrupt+0x16/0x20\ncpuidle_enter_state+0xfb/0x273\ncpu_startup_entry+0x15e/0x260\nstart_secondary+0x8a/0x90\nsecondary_startup_64_no_verify+0xfa/0xfb", "datePublished": "2024-11-07T09:31:30", "dateUpdated": "2025-11-03T22:26:13", "baseScore": 7.8, "baseScoreVersion": "3.1", "baseScoreVector": "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H", "references": ["https://git.kernel.org/stable/c/8459d61fbf24967839a70235165673148c7c7f17", "https://git.kernel.org/stable/c/5071beb59ee416e8ab456ac8647a4dabcda823b1", "https://git.kernel.org/stable/c/997ae8da14f1639ce6fb66a063dab54031cd61b3", "https://git.kernel.org/stable/c/51e34db64f4e43c7b055ccf881b7f3e0c31bb26d", "https://git.kernel.org/stable/c/e8c526f2bdf1845bedaf6a478816a3d06fa78b8f", "https://git.kernel.org/stable/c/106e457953315e476b3642ef24be25ed862aaba3", "https://git.kernel.org/stable/c/c964bf65f80a14288d767023a1b300b30f5b9cd0", "https://nvd.nist.gov/vuln/detail/CVE-2024-50154", "https://lists.debian.org/debian-lts-announce/2025/05/msg00030.html", "https://lists.debian.org/debian-lts-announce/2025/01/msg00001.html"], "aliases": ["CVE-2024-50154"], "assigner": "Linux", "epss": 0.02, "enisaIdProduct": [{"id": "1d8b8dcd-3805-3a09-b9f3-e4318ea9b0c9", "product": {"name": "Linux"}, "product_version": "patch: 6.11.6"}, {"id": "291aeec6-1e18-39cb-9508-5b3f3425b0b3", "product": {"name": "Linux"}, "product_version": "patch: 5.15.170"}, {"id": "3dc2310d-aa3a-3ca3-9026-0fdc5e3022a8", "product": {"name": "Linux"}, "product_version": "patch: 5.4.293"}, {"id": "672ae5bd-c183-3831-89b8-922980e417c5", "product": {"name": "Linux"}, "product_version": "83fccfc3940c4a2db90fd7e7079f5b465cd8c6af <c964bf65f80a14288d767023a1b300b30f5b9cd0"}, {"id": "7449bbf4-34d5-3669-961a-0c218fddfb0a", "product": {"name": "Linux"}, "product_version": "patch: 5.10.237"}, {"id": "9ce46c5b-00db-37e5-811c-4be8ab703ff9", "product": {"name": "Linux"}, "product_version": "83fccfc3940c4a2db90fd7e7079f5b465cd8c6af <5071beb59ee416e8ab456ac8647a4dabcda823b1"}, {"id": "9dda8add-13a8-369c-a724-e52a2c061af3", "product": {"name": "Linux"}, "product_version": "patch: 6.1.115"}, {"id": "a62b8524-c2c8-321d-8520-45f1ba6438a0", "product": {"name": "Linux"}, "product_version": "83fccfc3940c4a2db90fd7e7079f5b465cd8c6af <106e457953315e476b3642ef24be25ed862aaba3"}, {"id": "bfac03b0-bcf8-39e6-a18c-63a1f5747511", "product": {"name": "Linux"}, "product_version": "d3a1196bfc462943694623412d8e03aaf172bdc1"}, {"id": "c00a107d-874e-39da-bbef-ccbe043db278", "product": {"name": "Linux"}, "product_version": "83fccfc3940c4a2db90fd7e7079f5b465cd8c6af <997ae8da14f1639ce6fb66a063dab54031cd61b3"}, {"id": "c5e6ec51-7193-31f1-8ddf-6d1eda2a5878", "product": {"name": "Linux"}, "product_version": "83fccfc3940c4a2db90fd7e7079f5b465cd8c6af <8459d61fbf24967839a70235165673148c7c7f17"}, {"id": "c8a1cb75-90da-331d-81d6-b6cdd9b80a35", "product": {"name": "Linux"}, "product_version": "patch: 6.12"}, {"id": "cd252669-4f1f-31b1-93b5-3551aa79b17c", "product": {"name": "Linux"}, "product_version": "patch: 6.6.59"}, {"id": "d734ac64-275c-3006-b744-faa7c244160f", "product": {"name": "Linux"}, "product_version": "83fccfc3940c4a2db90fd7e7079f5b465cd8c6af <51e34db64f4e43c7b055ccf881b7f3e0c31bb26d"}, {"id": "dc76ce56-2a2d-359e-9911-555d7aeb717e", "product": {"name": "Linux"}, "product_version": "4.2"}, {"id": "df28e70f-d72e-35b6-9bf0-cecf6966dfbb", "product": {"name": "Linux"}, "product_version": "patch: 0"}, {"id": "e7fc99a6-8f0d-3488-a9cf-6988929a1169", "product": {"name": "Linux"}, "product_version": "83fccfc3940c4a2db90fd7e7079f5b465cd8c6af <e8c526f2bdf1845bedaf6a478816a3d06fa78b8f"}], "enisaIdVendor": [{"id": "e1e9276c-e356-3b1d-a34a-c9330bf1fcf5", "vendor": {"name": "Linux"}}], "isExploited": false}