{"id": "EUVD-2024-51849", "enisaUuid": "abdd6a6c-3df5-3db6-b364-536e9765c22b", "description": "In the Linux kernel, the following vulnerability has been resolved:\n\nsmb: prevent use-after-free due to open_cached_dir error paths\n\nIf open_cached_dir() encounters an error parsing the lease from the\nserver, the error handling may race with receiving a lease break,\nresulting in open_cached_dir() freeing the cfid while the queued work is\npending.\n\nUpdate open_cached_dir() to drop refs rather than directly freeing the\ncfid.\n\nHave cached_dir_lease_break(), cfids_laundromat_worker(), and\ninvalidate_all_cached_dirs() clear has_lease immediately while still\nholding cfids->cfid_list_lock, and then use this to also simplify the\nreference counting in cfids_laundromat_worker() and\ninvalidate_all_cached_dirs().\n\nFixes this KASAN splat (which manually injects an error and lease break\nin open_cached_dir()):\n\n==================================================================\nBUG: KASAN: slab-use-after-free in smb2_cached_lease_break+0x27/0xb0\nRead of size 8 at addr ffff88811cc24c10 by task kworker/3:1/65\n\nCPU: 3 UID: 0 PID: 65 Comm: kworker/3:1 Not tainted 6.12.0-rc6-g255cf264e6e5-dirty #87\nHardware name: VMware, Inc. VMware Virtual Platform/440BX Desktop Reference Platform, BIOS 6.00 11/12/2020\nWorkqueue: cifsiod smb2_cached_lease_break\nCall Trace:\n <TASK>\n dump_stack_lvl+0x77/0xb0\n print_report+0xce/0x660\n kasan_report+0xd3/0x110\n smb2_cached_lease_break+0x27/0xb0\n process_one_work+0x50a/0xc50\n worker_thread+0x2ba/0x530\n kthread+0x17c/0x1c0\n ret_from_fork+0x34/0x60\n ret_from_fork_asm+0x1a/0x30\n </TASK>\n\nAllocated by task 2464:\n kasan_save_stack+0x33/0x60\n kasan_save_track+0x14/0x30\n __kasan_kmalloc+0xaa/0xb0\n open_cached_dir+0xa7d/0x1fb0\n smb2_query_path_info+0x43c/0x6e0\n cifs_get_fattr+0x346/0xf10\n cifs_get_inode_info+0x157/0x210\n cifs_revalidate_dentry_attr+0x2d1/0x460\n cifs_getattr+0x173/0x470\n vfs_statx_path+0x10f/0x160\n vfs_statx+0xe9/0x150\n vfs_fstatat+0x5e/0xc0\n __do_sys_newfstatat+0x91/0xf0\n do_syscall_64+0x95/0x1a0\n entry_SYSCALL_64_after_hwframe+0x76/0x7e\n\nFreed by task 2464:\n kasan_save_stack+0x33/0x60\n kasan_save_track+0x14/0x30\n kasan_save_free_info+0x3b/0x60\n __kasan_slab_free+0x51/0x70\n kfree+0x174/0x520\n open_cached_dir+0x97f/0x1fb0\n smb2_query_path_info+0x43c/0x6e0\n cifs_get_fattr+0x346/0xf10\n cifs_get_inode_info+0x157/0x210\n cifs_revalidate_dentry_attr+0x2d1/0x460\n cifs_getattr+0x173/0x470\n vfs_statx_path+0x10f/0x160\n vfs_statx+0xe9/0x150\n vfs_fstatat+0x5e/0xc0\n __do_sys_newfstatat+0x91/0xf0\n do_syscall_64+0x95/0x1a0\n entry_SYSCALL_64_after_hwframe+0x76/0x7e\n\nLast potentially related work creation:\n kasan_save_stack+0x33/0x60\n __kasan_record_aux_stack+0xad/0xc0\n insert_work+0x32/0x100\n __queue_work+0x5c9/0x870\n queue_work_on+0x82/0x90\n open_cached_dir+0x1369/0x1fb0\n smb2_query_path_info+0x43c/0x6e0\n cifs_get_fattr+0x346/0xf10\n cifs_get_inode_info+0x157/0x210\n cifs_revalidate_dentry_attr+0x2d1/0x460\n cifs_getattr+0x173/0x470\n vfs_statx_path+0x10f/0x160\n vfs_statx+0xe9/0x150\n vfs_fstatat+0x5e/0xc0\n __do_sys_newfstatat+0x91/0xf0\n do_syscall_64+0x95/0x1a0\n entry_SYSCALL_64_after_hwframe+0x76/0x7e\n\nThe buggy address belongs to the object at ffff88811cc24c00\n which belongs to the cache kmalloc-1k of size 1024\nThe buggy address is located 16 bytes inside of\n freed 1024-byte region [ffff88811cc24c00, ffff88811cc25000)", "datePublished": "2024-12-27T13:49:21", "dateUpdated": "2025-02-11T15:45:26", "baseScore": 7.8, "baseScoreVersion": "3.1", "baseScoreVector": "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H", "references": ["https://git.kernel.org/stable/c/791f833053578b9fd24252ebb7162a61bc3f805b", "https://git.kernel.org/stable/c/97e2afcac0bebfef6a5360f4267ce4c44507b845", "https://git.kernel.org/stable/c/47655a12c6b1bca8fa230085eab2e85a076932b7", "https://git.kernel.org/stable/c/a9685b409a03b73d2980bbfa53eb47555802d0a9", "https://nvd.nist.gov/vuln/detail/CVE-2024-53177"], "aliases": ["CVE-2024-53177"], "assigner": "Linux", "epss": 0.04, "enisaIdProduct": [{"id": "4ede485d-256a-374a-9d85-b3c663f15b98", "product": {"name": "Linux"}, "product_version": "1da177e4c3f41524e886b7f1b8a0c1fc7321cac2 <47655a12c6b1bca8fa230085eab2e85a076932b7"}, {"id": "610361df-a877-3fde-bdde-f00e8538909d", "product": {"name": "Linux"}, "product_version": "patch: 6.13"}, {"id": "8d63661e-0832-3c26-bce0-22c5cd339d2b", "product": {"name": "Linux"}, "product_version": "patch: 6.12.2"}, {"id": "8f73ac93-3dc6-311a-966c-4363a4adf302", "product": {"name": "Linux"}, "product_version": "1da177e4c3f41524e886b7f1b8a0c1fc7321cac2 <791f833053578b9fd24252ebb7162a61bc3f805b"}, {"id": "bbe87da1-04d9-3791-beeb-95173822beb7", "product": {"name": "Linux"}, "product_version": "1da177e4c3f41524e886b7f1b8a0c1fc7321cac2 <97e2afcac0bebfef6a5360f4267ce4c44507b845"}, {"id": "d510e787-5319-3612-b466-faed0f0420fa", "product": {"name": "Linux"}, "product_version": "1da177e4c3f41524e886b7f1b8a0c1fc7321cac2 <a9685b409a03b73d2980bbfa53eb47555802d0a9"}, {"id": "d8f6ab85-e081-3b20-85aa-42b0f6719fa4", "product": {"name": "Linux"}, "product_version": "patch: 6.11.11"}, {"id": "ff43b439-ccc6-3095-924f-57cfad3a692f", "product": {"name": "Linux"}, "product_version": "patch: 6.6.64"}], "enisaIdVendor": [{"id": "c4ecca9f-02d1-3981-bc02-c1be1e377525", "vendor": {"name": "Linux"}}], "isExploited": false}