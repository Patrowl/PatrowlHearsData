{"id": "EUVD-2025-5177", "enisaUuid": "d3c777cb-051f-3d75-85b7-0ab1ca9079f2", "description": "In the Linux kernel, the following vulnerability has been resolved:\n\nscsi: ufs: core: Fix use-after free in init error and remove paths\n\ndevm_blk_crypto_profile_init() registers a cleanup handler to run when\nthe associated (platform-) device is being released. For UFS, the\ncrypto private data and pointers are stored as part of the ufs_hba's\ndata structure 'struct ufs_hba::crypto_profile'. This structure is\nallocated as part of the underlying ufshcd and therefore Scsi_host\nallocation.\n\nDuring driver release or during error handling in ufshcd_pltfrm_init(),\nthis structure is released as part of ufshcd_dealloc_host() before the\n(platform-) device associated with the crypto call above is released.\nOnce this device is released, the crypto cleanup code will run, using\nthe just-released 'struct ufs_hba::crypto_profile'. This causes a\nuse-after-free situation:\n\n  Call trace:\n   kfree+0x60/0x2d8 (P)\n   kvfree+0x44/0x60\n   blk_crypto_profile_destroy_callback+0x28/0x70\n   devm_action_release+0x1c/0x30\n   release_nodes+0x6c/0x108\n   devres_release_all+0x98/0x100\n   device_unbind_cleanup+0x20/0x70\n   really_probe+0x218/0x2d0\n\nIn other words, the initialisation code flow is:\n\n  platform-device probe\n    ufshcd_pltfrm_init()\n      ufshcd_alloc_host()\n        scsi_host_alloc()\n          allocation of struct ufs_hba\n          creation of scsi-host devices\n    devm_blk_crypto_profile_init()\n      devm registration of cleanup handler using platform-device\n\nand during error handling of ufshcd_pltfrm_init() or during driver\nremoval:\n\n  ufshcd_dealloc_host()\n    scsi_host_put()\n      put_device(scsi-host)\n        release of struct ufs_hba\n  put_device(platform-device)\n    crypto cleanup handler\n\nTo fix this use-after free, change ufshcd_alloc_host() to register a\ndevres action to automatically cleanup the underlying SCSI device on\nufshcd destruction, without requiring explicit calls to\nufshcd_dealloc_host(). This way:\n\n    * the crypto profile and all other ufs_hba-owned resources are\n      destroyed before SCSI (as they've been registered after)\n    * a memleak is plugged in tc-dwc-g210-pci.c remove() as a\n      side-effect\n    * EXPORT_SYMBOL_GPL(ufshcd_dealloc_host) can be removed fully as\n      it's not needed anymore\n    * no future drivers using ufshcd_alloc_host() could ever forget\n      adding the cleanup", "datePublished": "2025-02-27T02:12:14", "dateUpdated": "2025-03-24T15:39:37", "baseScore": 7.8, "baseScoreVersion": "3.1", "baseScoreVector": "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H", "references": ["https://nvd.nist.gov/vuln/detail/CVE-2025-21739", "https://git.kernel.org/stable/c/0c77c0d754fe83cb154715fcfec6c3faef94f207", "https://git.kernel.org/stable/c/9c185beae09a3eb85f54777edafa227f7e03075d", "https://git.kernel.org/stable/c/f8fb2403ddebb5eea0033d90d9daae4c88749ada"], "aliases": ["CVE-2025-21739", "GHSA-mxqw-697j-9cv7"], "assigner": "Linux", "epss": 0.04, "enisaIdProduct": [{"id": "26982063-0578-31de-9762-35a1fa7ee0ed", "product": {"name": "Linux"}, "product_version": "d76d9d7d1009968dd3a0fc30e5f5ee9fbffc1350 <0c77c0d754fe83cb154715fcfec6c3faef94f207"}, {"id": "422fcf42-c575-385e-b051-8c265e44a42b", "product": {"name": "Linux"}, "product_version": "d76d9d7d1009968dd3a0fc30e5f5ee9fbffc1350 <f8fb2403ddebb5eea0033d90d9daae4c88749ada"}, {"id": "753553a8-bd96-33cc-9ad8-dace35e049fb", "product": {"name": "Linux"}, "product_version": "5.12"}, {"id": "7f512924-7b18-3f01-b68e-3c8ab793fb71", "product": {"name": "Linux"}, "product_version": "d76d9d7d1009968dd3a0fc30e5f5ee9fbffc1350 <9c185beae09a3eb85f54777edafa227f7e03075d"}, {"id": "b7f9d203-e1ae-38ab-9c0c-ca7f8f5f133d", "product": {"name": "Linux"}, "product_version": "patch: 6.12.14"}, {"id": "bf56af5e-11f1-3b6e-b476-a61c1e3d32f0", "product": {"name": "Linux"}, "product_version": "patch: 0"}, {"id": "c2f6b7d9-f907-366a-ae1d-b5332d1e440f", "product": {"name": "Linux"}, "product_version": "patch: 6.14"}, {"id": "ec981963-1c32-30d7-aecb-17e85ffce0d4", "product": {"name": "Linux"}, "product_version": "patch: 6.13.3"}], "enisaIdVendor": [{"id": "9bc7369a-6edf-3f86-97eb-c14a11a50aa9", "vendor": {"name": "Linux"}}], "isExploited": false}